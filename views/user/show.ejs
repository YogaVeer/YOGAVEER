<% layout("layouts/boilerplate_user") %>

<!-- Toggle Button for Mobile -->
<button class="toggle-btn d-md-none" onclick="toggleSidebar()">☰ Courses</button>

<script>
  function toggleSidebar() {
    const sidebar = document.querySelector('.border-end');
    sidebar.classList.toggle('open');
  }
</script>

<div class="container-fluid">
  <div class="row" style="margin-top: 70px; border-radius: 30%;">
    <!-- Sidebar -->
    <div class="col-md-4 border-end vh-100 overflow-auto">
      <h3 class="mt-4 mb-3 text-dark"><%= course.name %></h3>
      <% if (courseUnlocked) { %>
        <p class="text-success small mb-2">
          ✅ Unlocked – expires in 
          <%= Math.ceil((new Date(access.expiresAt) - new Date()) / (1000 * 60 * 60 * 24)) %> days 
          (on <%= new Date(access.expiresAt).toLocaleDateString() %>)
        </p>
      <% } %>

      <% if (!courseUnlocked) { %>
        <div class="alert alert-warning">This course is locked. Unlock to view lessons.</div>
      <% } %>

      <% fullStructure.forEach(({ section, lessons }) => { %>
        <div class="mb-3 opacity-<%= courseUnlocked ? '100' : '50' %>">
          <h5 class="text-secondary"><%= section.title %></h5>
          <ul class="list-group">
            <% lessons.forEach(lesson => { %>
              <li class="list-group-item <%= currentLesson && currentLesson._id.toString() === lesson._id.toString() ? 'active' : '' %>">
                <% if (courseUnlocked) { %>
                  <a href="/user/courses/<%= course._id %>?lessonId=<%= lesson._id %>" class="text-decoration-none <%= currentLesson && currentLesson._id.toString() === lesson._id.toString() ? 'text-white' : '' %>">
                    <%= lesson.title %>
                  </a>
                <% } else { %>
                  <span class="text-muted"><%= lesson.title %></span>
                <% } %>
              </li>
            <% }) %>
          </ul>
        </div>
      <% }) %>
    </div>

    <!-- Main content -->
    <div class="col-md-8 p-4">
      <% if (courseUnlocked && currentLesson && currentLesson.videoPath) { %>
        <h3 style="padding: 50px; font-size: 2.5rem;"><%= currentLesson.title %></h3>
        <video width="100%" height="400" controls autoplay controlsList="nodownload" oncontextmenu="return false;">
          <source src="<%= currentLesson.videoPath %>" type="video/mp4">
          Your browser does not support the video tag.
        </video>
        <div class="mt-3 text-center">
          <a href="https://chat.whatsapp.com/KV2FbGZojMNFsDGpWiR2Un" target="_blank" class="btn btn-success btn-lg shadow">
            Join Our WhatsApp Community
          </a>
        </div>
      <% } else if (!courseUnlocked) { %>
        <div class="text-center mt-5">
          <h4 style="padding-top: 80px;">This course is locked</h4>
          <% if (access && new Date(access.expiresAt) <= new Date()) { %>
            <p class="text-danger">Your access expired on <%= new Date(access.expiresAt).toLocaleDateString() %>.</p>
          <% } else { %>
            <p>Unlock to get full access for 45 days.</p>
          <% } %>

          <button class="btn btn-primary" id="unlock-btn">
            Unlock for ₹<%= course.price %>
          </button>
        </div>
      <% } else { %>
        <p class="text-muted">No lesson selected or available.</p>
      <% } %>
    </div>
  </div>
</div>

<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  document.getElementById("unlock-btn")?.addEventListener("click", async () => {
    const courseId = "<%= course._id %>";
    const courseType = "aspirants";
    const userId = "<%= user._id %>";

    try {
      const res = await fetch("/payment/create-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ courseId, courseType })
      });

      const data = await res.json();

      const options = {
        key: "<%= razorpayKeyId %>",
        amount: data.order.amount,
        currency: "INR",
        name: "YOGAVEER",
        description: "Course Unlock",
        order_id: data.order.id,
        handler: function (response) {
          fetch("/payment/verify_payment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              razorpay_order_id: data.order.id,
              razorpay_payment_id: response.razorpay_payment_id,
              razorpay_signature: response.razorpay_signature,
              courseId,
              courseType,
              userId,
              amount: data.order.amount 
            })
          }).then(() => window.location.reload());
        }
      };

      const rzp = new Razorpay(options);
      rzp.open();
    } catch (err) {
      alert("Payment setup failed");
      console.error(err);
    }
  });
</script>

<!-- Styles: Same as before with responsive toggle and sidebar slide -->
<style>
  body {
    background: linear-gradient(135deg, #dbe4f0, #c8d4e8, #e3e3e3);
    background-attachment: fixed;
    background-size: cover;
    font-family: 'Segoe UI', 'Poppins', sans-serif;
    font-size: 16px;
    color: #2e2e2e;
    transition: all 0.3s ease-in-out;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  h3, h4, h5 {
    font-weight: 700;
    letter-spacing: -0.5px;
    color: #1e1e2f;
  }

  .container-fluid {
    padding: 0 1rem;
    flex: 1;
  }

  .border-end {
    background: #ffffff;
    border-right: 2px solid #eee;
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.03);
    animation: slideLeft 0.6s ease;
    transition: left 0.3s ease, transform 0.3s ease;
  }

  .col-md-8 {
    background: linear-gradient(to bottom right, #f9fcff, #f3f4ff);
    border-left: 2px solid #eee;
    animation: fadeIn 0.6s ease;
    padding-bottom: 20px;
  }

  ul.list-group {
    background: transparent;
  }

  .list-group-item {
    background: #f6f8fa;
    border: none;
    border-radius: 10px !important;
    margin-bottom: 8px;
    padding: 10px 15px;
    color: #3a3a5a;
    font-weight: 500;
    transition: all 0.3s ease;
    transform-origin: left;
  }

  .list-group-item:hover {
    background: #e4f0fa;
    transform: scale(1.02);
    box-shadow: 0 2px 6px rgba(0, 132, 255, 0.1);
    cursor: pointer;
  }

  .list-group-item.active {
    background: linear-gradient(90deg, #7f7fd5, #86a8e7, #91eae4) !important;
    color: #fff !important;
    font-weight: 700;
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
  }

  .list-group-item a {
    text-decoration: none;
    color: #2b2b5c;
  }

  .list-group-item a.text-white {
    color: #fff !important;
  }

  video {
    width: 100%;
    max-height: 480px;
    border-radius: 14px;
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.1);
    animation: zoomIn 0.6s ease;
    object-fit: cover;
  }

  @media (max-width: 768px) {
    video {
      max-height: 280px;
    }
  }

  .text-success.small {
    font-size: 0.85rem;
    background: #e0f9e8;
    color: #1d7a3a;
    padding: 6px 12px;
    border-radius: 6px;
    font-weight: 600;
  }

  .alert-warning {
    background: #fff4e5;
    color: #8a6d3b;
    border-left: 4px solid #ffb84d;
    font-weight: 500;
    border-radius: 6px;
    padding: 12px;
  }

  .text-muted, .text-secondary {
    color: #5c6370 !important;
    font-size: 0.9rem;
  }

  .opacity-50 {
    opacity: 0.5;
  }

  .opacity-100 {
    opacity: 1;
  }

  .btn-success {
    background: linear-gradient(to right, #28a745, #218838);
    border: none;
    padding: 14px 26px;
    font-weight: 600;
    border-radius: 8px;
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
    transition: all 0.3s ease;
    color: white;
  }

  .btn-success:hover {
    background: #1e7e34;
    transform: scale(1.05);
  }

  .btn-primary {
    background: linear-gradient(to right, #004e92, #000428);
    color: white;
    font-weight: bold;
    border: none;
    padding: 14px 26px;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0, 0, 66, 0.3);
    transition: all 0.3s ease;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    opacity: 0.95;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes slideLeft {
    from { opacity: 0; transform: translateX(-30px); }
    to { opacity: 1; transform: translateX(0); }
  }

  @keyframes zoomIn {
    from { transform: scale(0.95); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  /* === Responsive Sidebar Toggle === */
  .toggle-btn {
    position: fixed;
    top: 105px;
    left: 30px;
    z-index: 1;
    background-color: #7f7fd5;
    color: white;
    border: none;
    padding: 10px 14px;
    font-size: 18px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    display: none;
  }

  @media (max-width: 768px) {
    .toggle-btn {
      display: block;
    }

    .border-end {
      position: fixed;
      left: -100%;
      top: 0;
      height: 100vh;
      width: 85%;
      z-index: 3;
      background-color: #fff;
      transition: left 0.3s ease;
    }

    .border-end.open {
      left: 0;
    }

    .col-md-4 {
      width: 70%;
    }
  }
</style>